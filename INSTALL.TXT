.. This file is written in ReStructuredText and used to generate the content of some web pages

Installation instructions for Debian based systems
==================================================

#. To get the development files::

   cd /usr/local/
   hg clone http://gridcalendar.net:8001 gridcalendar

  You can then update your local copy with the newest changes anytime with the commands::

   hg pull
   hg update

#. Install the following packages: ``python python-django python-django-registration python-django-tagging python-docutils python-dateutil python-geoip python-vobject binutils python-setuptools``. Django must be at least Version 1.2.3

#. Install ``django-tables``::

    easy_install django-tables

#. If you want to be able to locate cities by the user's IPs, you need to install the data base of
   Maxmind.com which askes you to mention it. Read http://geolite.maxmind.com/download/geoip/database/LICENSE.txt
   Using this data improves the front page, search results and the introduction of addresses of events.
   You can install it following the steps::
    
    cd /usr/share/GeoIP
    wget http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz
    gzip -d GeoLiteCity.dat.gz

#. If you want to develop GridCalendar:
   
   #. Install ``python-django-debug-toolbar``, ``python-profiler``, ``python-webtest`` and ``django-webtest``. As root::

        aptitude install python-django-debug-toolbar python-webtest
        easy_install django-webtest

   #. Set in ``settings_local.py`` (see below) the variable ``DEBUG`` to ``True`` and add the
      IP(s) you use when developing. Example::

        DEBUG = True
        INTERNAL_IPS = ('127.0.0.1', '85.183.50.38')

   #. You can run a web test server with ``python manage.py testserver``

   #. To run the tests, issue ``python manage.py tests``. If you see an error saying that 404.html
      could not been found, you need to set ``DEBUG`` to ``False`` before running the tests

#. Create and edit ``settings_local.py`` (see an example at ``settings_local.py.example``)

#. It is needed to run a command each day at 00:01 (just after midnight), which will update a field
in the database (Event.upcoming) which is needed for sorting the events and finding events in the
future. This is necessary for performance and scalability reasons. Add to you cron file::

   cd /usr/local/gridcalendar ; python /usr/local/gridcalendar/manage.py updateupcoming

#. To parse events submitted as emails to an imap server automatically, add to your cron file::

   cd /usr/local/gridcalendar ; python /usr/local/gridcalendar/manage.py imap

#. For Apache as the webserver
   
    #. Install Apache and the package ``libapache2-mod-wsgi``
      
    #. For an Apache Virtual Server, you need to use something like the following as ``/etc/apache2/sites-available/gridcalendar.net``::

        <VirtualHost *:80>
            ServerName gridcalendar.net
            ServerAlias www.gridcalendar.net
            DocumentRoot /var/www/gridcalendar.net
            ServerAdmin admin@example.com
        
            # Logfiles:
            CustomLog /var/log/apache2/gridcalendar.net.log combined
            ErrorLog /var/log/apache2/gridcalendar.net.error.log
            LogLevel warn
         
            Alias /robots.txt /var/www/gridcalendar.net/robots.txt
            Alias /m/ /var/www/gridcalendar.net/m/
            Alias /favicon.ico /var/www/gridcalendar.net/m/favicon.ico

            WSGIScriptAlias / /usr/local/gridcalendar/apache/django.wsgi
        
        </VirtualHost>

    #. Make ``/var/www/gridcalendar.net/m/`` a symbolic link to ``/usr/local/gridcalendar/media`` and make sure Apache can read it::

        ln -s /usr/local/gridcalendar/media /var/www/gridcalendar.net/m/

    #. The same for ``favicon.ico``::

        ln -s /usr/local/gridcalendar/media/favicon.ico /var/www/gridcalendar.net/favicon.ico

    #. Don't forgett to create a file ``/var/www/gridcalendar/robots.txt`` for the search engines, see http://en.wikipedia.org/wiki/Robots.txt

    #. If you use SQLite as the database, Make sure Apache can also write to the parent
       directory of the database. SQLite needs to be able to write to this directory.

#. If Apache is used, for development it is recommended to include the following line in ``/etc/apache2/apache2.conf``. It makes the server reload every request, in order to be able to see changes immediately. Remove this in the production version::

        MaxRequestsPerChild 1
   
#. If you want to use a single SQLite file for storing your data:

   #. Install the packages ``python-pysqlite2`` and ``sqlite3``
   
   #. configure ``settings_local.py`` accordingly and make sure that the file is writable by the web server username (``www-data`` in Debian). In the ``settings_local.py`` you can put::

        DATABASE_ENGINE   = 'sqlite3'
        DATABASE_NAME     = os.path.join(PROJECT_ROOT, 'gridcalendar.sqlite')

    #. Install the Django tables::

        $ cd /usr/local/gridcalendar/
        $ python manage.py syncdb
        ...
        You just installed Django's auth system, which means you don't have any superusers defined.
        Would you like to create one now? (yes/no): yes
        ...

    #. Configure the ``django_site`` table. **Important note**: the first entry in this table is
       used when sending emails outside of the web, e.g. by ``events/management/commands/imap.py``
       which can be used by a cronjob to read and reply emails. Configure the table with::

        cd /usr/local/gridcalendar
        sqlite3 gridcalendar.sqlite
        update django_site set domain='gridcalendar.net' where id=1 ;
        update django_site set name='Grid Calendar' where id=1 ;

#. If you want to use postgresql (instead of SQLite) for storing your data:
   
    #. Install the packages ``postgresql-8.3`` and ``python-psycopg2``

    #. as root edit your ``/etc/postgresql/*/main/pg_hba.conf`` file to include: ``local all gridcalendar md5``

    #. reload the configuration: ``killall -HUP postgres``

    #. create the GridCalendar ``postgres`` user with a password::

        $ su
        # su postgres
        postgres$ createuser --pwprompt gridcalendar
        Enter password for new role:
        Enter it again:
        Shall the new role be a superuser? (y/n) n
        Shall the new role be allowed to create databases? (y/n) y
        Shall the new role be allowed to create more new roles? (y/n) n

    #. create the gridcalendar database::

        postgres$ createdb -U gridcalendar -O gridcalendar gridcalendar
        Password:

    #. Install the Django tables::

        $ cd /usr/local/gridcalendar/
        $ python manage.py syncdb
        ...
        You just installed Django's auth system, which means you don't have any superusers defined.
        Would you like to create one now? (yes/no): yes
        ...

    #. Configure the ``django_site`` table. **Important note**: the first entry in this table is
       used when sending emails outside of the web, e.g. by ``events/management/commands/imap.py``
       which can be used by a cronjob to read and reply emails. Configure the table with::

        update django_site set domain='gridcalendar.net' where id=1 ;
        update django_site set name='Grid Calendar' where id=1 ;

#. **Emails**: the system gets and sends emails. See the ``settings_local.py`` file for the settings
   of it.

    #. Group invitations are sent with the sender (``from`` header) set to the user
       ``group-invitation`` and the host provided by the setting ``DEFAULT_FROM_EMAIL``
 
#. **Graph of the data base**: To generate a graph of the data base::

    cd /usr/local/gridcalendar/
    aptitude install graphviz ttf-liberation
    wget http://djangosnippets.org/snippets/1168/download/
    export PYTHONPATH="/home/hg/gridcalendar:/home/hg/"
    export DJANGO_SETTINGS_MODULE="gridcalendar.settings"
    python graph_db.py events | dot -Tpng -o media/graph_db.png
