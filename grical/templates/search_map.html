{# Copyright: 2016 George Vlachos <george Ã¤t wikical dot com> #}
{% load i18n %}

<div class="container-fluid m-t-1">
    <div class="row">
        <div class="col-xs-12">
            <div id="map" class="smallmap"></div>
            {# TODO: add info of events when clicking on them: http://openlayers.org/dev/examples/dynamic-text-layer.html #}

            {# Using local OpenLayers.js because of Mixed content restrictions #}
            {# TODO: Replace with bower #}
            <script type="text/javascript" src="{{ STATIC_URL }}js/OpenLayers.js"></script>

            <script defer="defer" type="text/javascript">
                //<![CDATA[

                function marker( lon, lat, image ) {
                    return new OpenLayers.Marker(
                        new OpenLayers.LonLat( lon, lat ).transform(
                            new OpenLayers.Projection( "EPSG:4326" ),
                            map.getProjectionObject()
                        ),
                        new OpenLayers.Icon( image, new OpenLayers.Size( 40, 40 ), new OpenLayers.Pixel( -10, -35 ) )
                    );
                }
                map = new OpenLayers.Map( "map", {
                        controls:[
                            new OpenLayers.Control.Navigation(),
                            new OpenLayers.Control.PanZoomBar(),
                            new OpenLayers.Control.LayerSwitcher(),
                            new OpenLayers.Control.Attribution()],
                        projection: new OpenLayers.Projection( "EPSG:900913" ),
                        displayProjection: new OpenLayers.Projection( "EPSG:4326" )
                } );
                map.addLayer( new OpenLayers.Layer.OSM() );
                var pois = new OpenLayers.Layer.Markers( "{% trans "Marker" %}" );
                //These lines should be a list automatically generated by Django
                {% for event in page.object_list %}
                    {% if event.coordinates %}
                        color_nr = {{ event.color_nr }}
                        pois.addMarker( this.marker( {{ event.coordinates.x }}, {{ event.coordinates.y }},
                                    "{{ STATIC_URL }}markers/color_{{ event.color_nr }}_nr_{{ forloop.counter0 }}.png" ) );
                    {% endif %}
                {% endfor %}
                map.addLayer( pois );
                mapArea = pois.getDataExtent().toArray();
                map.setCenter (
                    new OpenLayers.LonLat( ( mapArea[0] + mapArea[2]) /2, ( mapArea[1] + mapArea[3] ) /2 ),
                    map.getZoomForExtent( pois.getDataExtent(), true ) -1
                );

                //]]>
            </script>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <div class="map_legend m-t-1">
                <ul>
                    {% for event in page.object_list %}
                        <li>
                            {% if event.coordinates %}
                                <img class="marker" src="{{ STATIC_URL }}markers/color_{{ event.color_nr }}_nr_{{ forloop.counter0 }}.png"
                                    alt="color_{{ event.color_nr }}_nr_{{ forloop.counter0 }}" />
                            {% endif %}
                            {% include "event_show_small.html" %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
