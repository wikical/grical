{% extends "base.html" %}

{% load i18n %}
{% load event_tags %} 
{% load urlsearch %}
{% load comments %}

{% block container %}
<div class="event_full">

    <div class="options">
        <a href="{% url event_show_ical event.id %}"><img alt="ICAL" src="{{ MEDIA_URL }}icalicon.png" width="16" /></a>
        &nbsp;|&nbsp;
        <a href="{% url event_edit event.id %}">{% trans "edit" %}</a>
        &nbsp;|&nbsp;
        <a href="{% url event_edit_raw event.id %}"><span class="field_link">{% trans "edit as text" %}</span></a>
        &nbsp;|&nbsp;
        <a href="{% url event_history event.id %}">{% trans "history" %}</a>
        &nbsp;|&nbsp;
        {% show_add_to_group %}
        {% if user.is_authenticated %}
            &nbsp;|&nbsp;
            <a href="{% url event_delete event.id %}">{% trans "delete" %}</a>
        {% endif %}
    </div>

    <div class="dates">
        {{ event.start }}
        {% if event.starttime %}
            <span class="times">
                {{ event.starttime|time }}{% if event.endtime %}{% if not event.end or event.start == event.end %}-{{ event.endtime|time }}{% endif %}{% endif %}
            </span>
        {% endif %}
        {% if event.end and not event.start == event.end %}
            : {{ event.end }}
            {% if event.endtime %}
                <span class="times">
                    {{ event.endtime|time }}
                </span>
            {% endif %}
        {% endif %}
    </div>

    <div class="title">
        {% if event.acronym %}{{ event.acronym|escape }} - {% endif %}{{ event.title|escape }}
    </div>

    {% if event.address or event.postcode or event.city or event.country or event.coordinates %}
        <p>
            {% if event.address %}
                {{ event.address }}
            {% endif %}
            {% if event.postcode %}
                &nbsp; &#8212; &nbsp;
                {{ event.postcode }}
            {% endif %}
            {% if event.city %}
                &nbsp; &#8212; &nbsp;
                <span class="field_city"><a href="{% urlsearch city=event.city country=event.country %}">{{ event.city|capfirst }}</a></span>
            {% endif %}
            {% if event.country %}
                &nbsp; &#8212; &nbsp;
                <span class="field_country">
                    <a href="{% urlsearch country=event.country %}">{{ event.country|capfirst }}</a>
                </span>
            {% endif %}
            {% if event.coordinates %}
                &nbsp; &#8212; &nbsp;
                {{ event.coordinates.y }}, {{ event.coordinates.x }}
                ( <a href="http://www.openstreetmap.org/?mlat={{ event.coordinates.y }}&amp;mlon={{ event.coordinates.x }}&amp;zoom=15&amp;layers=B000FTF">OpenStreetMap</a>,
                <a href="http://maps.google.com?q={{ event.coordinates.y }},{{ event.coordinates.x }}">Google</a> )
            {% endif %}
        </p>
    {% endif %}

    {% if event.get_tags %}
        <p class='tags'>
            {% for tag in event.get_tags %}
                <a href="{% urlsearch tag=tag %}">{{ tag }}</a>
            {% endfor %}
        </p>
    {% endif %}

    {% if event.urls.all %}
        <ul class='urls'>
            {% for url in event.urls.all %}
                <li><a href="{{ url.url }}">{{ url.url_name|escape }}</a></li>
            {% endfor %}
        </ul>
    {% endif %}

    {% if event.recurring %}{# is part of a serie as intermediate instance OR is master of a serie #}
        <p>{% trans "Recurring events:" %}</p>
        <ul>
            {% for recurrence in event.recurring.master.recurrences.all %}
                {% with recurrence.event as event %}
                    <li>{% include "event_show_small.html" %}</li>
                {% endwith %}
            {% endfor %}
        </ul>
    {% endif %}

    {% if event.deadlines.all %}
        <table>
            {% for deadline in event.deadlines.all %}
                <tr>
                    <td>{{ deadline.deadline }}</td><td>{{ deadline.deadline_name|escape }}</td>
                </tr>
            {% endfor %}
        </table>
    {% endif %}
            
    {% if event.sessions.all %}
        <table>
            {% for session in event.sessions.all %}
                <tr>
                    <td>{{ session.session_date }}</td>
                    <td>{{ session.session_starttime|time:"H:i" }} - {{ session.session_endtime|time:"H:i" }}</td>
                    <td>{{ session.session_name|escape }}</td>
                </tr>
            {% endfor %}
        </table>
    {% endif %}

    {% if event.description %}
        <fieldset>
        <legend>{% trans "Description" %}</legend>
            {% if rst2html %}
                {{ rst2html|safe }}
            {% else %}
                {{ event.description|escape|linebreaksbr|urlize }}
            {% endif %}
        </fieldset>
    {% endif %}

    {% if event.coordinates %}
        {% comment %}FIXME: if the window of the browser is too small, the map breaks
        everything. Solution: check with JavaScript the size of the window and reduce the map
        accordingly. Note: the size is given in main.css currently {% endcomment %}
        <!-- see example http://openlayers.org/dev/examples/xhtml.html -->
        <div id="map" class="smallmap"></div>
        <script type="text/javascript" src="http://www.openlayers.org/api/OpenLayers.js"></script>
        <!-- <script type="text/javascript" src="{{ MEDIA_URL }}js/OpenLayers.js"></script> -->
        <script defer="defer" type="text/javascript">
            function marker( lon, lat, image ) {
                return new OpenLayers.Marker(
                    new OpenLayers.LonLat( lon, lat ).transform(
                        new OpenLayers.Projection( "EPSG:4326" ),
                        map.getProjectionObject()
                    ),
                    new OpenLayers.Icon( image, new OpenLayers.Size( 32, 32 ), new OpenLayers.Pixel( -16, -16 ) )
                );
            }
            map = new OpenLayers.Map( "map", {
                    controls:[
                        new OpenLayers.Control.Navigation(),
                        new OpenLayers.Control.PanZoomBar(),
                        new OpenLayers.Control.LayerSwitcher(),
                        new OpenLayers.Control.Attribution()],
                    projection: new OpenLayers.Projection( "EPSG:900913" ),
                    displayProjection: new OpenLayers.Projection( "EPSG:4326" )
            } );
            map.addLayer( new OpenLayers.Layer.OSM() );
            var pois = new OpenLayers.Layer.Markers( "{% trans "Marker" %}" );
            //These lines should be a list automatically generated by Django
            pois.addMarker( this.marker( {{ event.coordinates.x }}, {{ event.coordinates.y }}, "{{ MEDIA_URL }}marker_red.png" ) );
            map.addLayer( pois );
            mapArea = pois.getDataExtent().toArray();
            // map.zoomToMaxExtent();
            map.setCenter (
                new OpenLayers.LonLat( ( mapArea[0] + mapArea[2]) /2, ( mapArea[1] + mapArea[3] ) /2 ),
                map.getZoomForExtent( pois.getDataExtent(), true ) -1
            );
        </script>
    {% endif %}

    {# comments #} {# TODO: make comment form available for non-logged-in users but with a captcha #}
    {% get_comment_count for event as comment_count %}
    <h2>{% trans "Comments" %}</h2>
    {% if comment_count > 0 %}
        {% render_comment_list for event %}
    {% else %}
        {% if not user.is_authenticated %}
            <p>{% trans "There are so far no comments about this event." %}</p>
        {% endif %}
    {% endif %}
    {% if user.is_authenticated %}
        {% render_comment_form for event %}
    {% else %}
        <p><a href="{% url auth_login %}">{% trans "Log in to add a comment." %}</a></p>
        {# TODO: redirect user to the position to add a comment to this event after logging in #}
    {% endif %}

</div>
{% endblock %}
